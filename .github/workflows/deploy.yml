name: Deploy (VPS)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH into VPS and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          # ðŸ‘‰ Si tu as un mot de passe (simple) :
          password: ${{ secrets.SSH_PASSWORD }}
          # ðŸ‘‰ Si tu utilises une clÃ© (recommandÃ©), commente 'password' et utilise :
          # key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -euo pipefail
            cd ~/radar-fr
            echo "[1/4] Pull du codeâ€¦"
            git fetch origin main && git reset --hard origin/main

            echo "[2/4] Build de l'imageâ€¦"
            docker build -t radar-fr-app -f app/Dockerfile .

            echo "[3/4] (Re)lance le stackâ€¦"
            cd deploy
            docker compose up -d --remove-orphans

            echo "[4/4] Healthcheckâ€¦"
            curl -fsS https://api.attila-software.fr/healthz >/dev/null
            echo "âœ… DÃ©ploiement OK"
